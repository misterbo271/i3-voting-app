{% extends 'management/base.html' %}

{% block title %}Admin Actions{% endblock %}

{% block page_icon %}<i class="fas fa-cogs me-2"></i>{% endblock %}

{% block content %}
<div class="row">
    <!-- Backend Status -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-server me-2"></i>Backend Server Status
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-6">
                        <strong>Status:</strong>
                    </div>
                    <div class="col-sm-6">
                        {% if backend_status == 'healthy' %}
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle me-1"></i>Healthy
                            </span>
                        {% else %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times-circle me-1"></i>Error
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                {% if backend_info %}
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <strong>Details:</strong>
                            <pre class="bg-light p-2 mt-2 rounded"><code>{{ backend_info|pprint }}</code></pre>
                        </div>
                    </div>
                {% endif %}
                
                <hr>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="checkBackendHealth()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh Status
                </button>
            </div>
        </div>
    </div>

    <!-- Data Management -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-database me-2"></i>Data Management
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success" onclick="syncVotes()">
                        <i class="fas fa-download me-2"></i>Sync Votes from Backend
                    </button>
                    
                    <button type="button" class="btn btn-info" onclick="syncResults()">
                        <i class="fas fa-chart-bar me-2"></i>Sync Results from Backend
                    </button>
                    
                    <button type="button" class="btn btn-primary" onclick="syncAll()">
                        <i class="fas fa-sync me-2"></i>Sync All Data
                    </button>
                    
                    <hr>
                    
                    <button type="button" class="btn btn-warning" onclick="exportData()">
                        <i class="fas fa-file-export me-2"></i>Export Data (JSON)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Danger Zone -->
<div class="row">
    <div class="col-12">
        <div class="card shadow border-danger">
            <div class="card-header bg-danger text-white py-3">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning!</strong> The actions below are irreversible and will affect both the backend server and local database.
                </div>
                
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card border-danger h-100">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-trash me-2"></i>Reset All Votes
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">
                                    <strong>‚ö†Ô∏è IRREVERSIBLE ACTION</strong><br>
                                    This will permanently delete all votes from both the backend server and local database.
                                </p>
                                <div class="mb-3">
                                    <strong>Impact:</strong>
                                    <ul class="small text-muted mb-0">
                                        <li>All vote records deleted</li>
                                        <li>Vote counts reset to zero</li>
                                        <li>Voting history cleared</li>
                                        <li>Team rankings reset</li>
                                    </ul>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-danger" onclick="showResetConfirmation()">
                                        <i class="fas fa-trash me-2"></i>Reset All Votes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-4">
                        <div class="card border-warning h-100">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-mobile-alt me-2"></i>Reset Device IDs
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">
                                    <strong>üîÑ VOTING RESET</strong><br>
                                    Reset all device identifiers to allow users to vote again. Votes remain intact.
                                </p>
                                <div class="mb-3">
                                    <strong>Impact:</strong>
                                    <ul class="small text-muted mb-0">
                                        <li>Users can vote again</li>
                                        <li>Team selections cleared</li>
                                        <li>Existing votes preserved</li>
                                        <li>Vote counts unchanged</li>
                                    </ul>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-warning" onclick="showResetDevicesConfirmation()">
                                        <i class="fas fa-mobile-alt me-2"></i>Reset Device IDs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-4">
                        <div class="card border-info h-100">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-broom me-2"></i>Clear Local Cache
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">
                                    <strong>üóÉÔ∏è SAFE OPERATION</strong><br>
                                    Clear only the local Django database cache. Backend data remains intact.
                                </p>
                                <div class="mb-3">
                                    <strong>Impact:</strong>
                                    <ul class="small text-muted mb-0">
                                        <li>Local cache cleared</li>
                                        <li>Backend data safe</li>
                                        <li>Fresh data on next sync</li>
                                        <li>No vote loss</li>
                                    </ul>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-info" onclick="clearLocalCache()">
                                        <i class="fas fa-broom me-2"></i>Clear Local Cache
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reset Votes Confirmation Modal -->
<div class="modal fade" id="resetConfirmationModal" tabindex="-1" aria-labelledby="resetConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="resetConfirmationModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è DANGER: Reset All Votes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger border-0" role="alert">
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="alert-heading">This action is IRREVERSIBLE!</h6>
                            <p class="mb-0">Once confirmed, all voting data will be permanently deleted and cannot be recovered.</p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-danger">What will be deleted:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-times text-danger me-2"></i>All vote records from backend</li>
                            <li><i class="fas fa-times text-danger me-2"></i>All local cached data</li>
                            <li><i class="fas fa-times text-danger me-2"></i>Vote counts and statistics</li>
                            <li><i class="fas fa-times text-danger me-2"></i>Complete voting history</li>
                            <li><i class="fas fa-times text-danger me-2"></i>Team rankings</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-info">What will happen:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-arrow-right text-info me-2"></i>All teams reset to 0 votes</li>
                            <li><i class="fas fa-arrow-right text-info me-2"></i>Users can vote again</li>
                            <li><i class="fas fa-arrow-right text-info me-2"></i>Fresh voting session starts</li>
                            <li><i class="fas fa-arrow-right text-info me-2"></i>Device IDs also reset</li>
                        </ul>
                    </div>
                </div>
                
                <hr>
                <div class="bg-light p-3 rounded">
                    <h6 class="text-dark mb-3">
                        <i class="fas fa-keyboard me-2"></i>Security Confirmation Required
                    </h6>
                    <p class="mb-2"><strong>Type exactly:</strong> <code class="text-danger">RESET ALL VOTES</code></p>
                    <input type="text" class="form-control form-control-lg" id="resetConfirmationInput" 
                           placeholder="Type the confirmation text here..." autocomplete="off">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        This confirmation helps prevent accidental deletions
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger btn-lg" id="confirmResetBtn" onclick="resetAllVotes()" disabled>
                    <i class="fas fa-trash me-2"></i>Yes, Reset All Votes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Device IDs Confirmation Modal -->
<div class="modal fade" id="resetDevicesModal" tabindex="-1" aria-labelledby="resetDevicesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="resetDevicesModalLabel">
                    <i class="fas fa-mobile-alt me-2"></i>üîÑ Reset Device IDs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning border-0" role="alert">
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="alert-heading">This will allow all users to vote again!</h6>
                            <p class="mb-0">Device identifiers will be reset, but existing votes will be preserved.</p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-warning">What will be reset:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-redo text-warning me-2"></i>All device/IP identifiers</li>
                            <li><i class="fas fa-redo text-warning me-2"></i>Team selections on devices</li>
                            <li><i class="fas fa-redo text-warning me-2"></i>"Has voted" status</li>
                            <li><i class="fas fa-redo text-warning me-2"></i>User session data</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">What will be preserved:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>All existing votes</li>
                            <li><i class="fas fa-check text-success me-2"></i>Vote counts and totals</li>
                            <li><i class="fas fa-check text-success me-2"></i>Team rankings</li>
                            <li><i class="fas fa-check text-success me-2"></i>Voting history</li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Use Case:</strong> This is useful when you want to allow the same users to vote multiple times 
                    (e.g., multiple voting rounds) while keeping the previous voting data for analysis.
                </div>
                
                <hr>
                <div class="bg-light p-3 rounded">
                    <h6 class="text-dark mb-3">
                        <i class="fas fa-keyboard me-2"></i>Confirmation Required
                    </h6>
                    <p class="mb-2"><strong>Type exactly:</strong> <code class="text-warning">RESET DEVICES</code></p>
                    <input type="text" class="form-control form-control-lg" id="resetDevicesInput" 
                           placeholder="Type the confirmation text here..." autocomplete="off">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        This is a safety measure to prevent accidental resets
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-warning btn-lg" id="confirmResetDevicesBtn" onclick="resetAllDevices()" disabled>
                    <i class="fas fa-mobile-alt me-2"></i>Yes, Reset Device IDs
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Backend health check
function checkBackendHealth() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    btn.disabled = true;
    
    fetch('{% url "management:health_check_ajax" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Backend is healthy and responding');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('danger', 'Backend health check failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to check backend health: ' + error.message);
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

// Sync functions
function syncVotes() {
    performSync('votes', '{% url "management:sync_votes_ajax" %}');
}

function syncResults() {
    performSync('results', '{% url "management:sync_results_ajax" %}');
}

function syncAll() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing All...';
    btn.disabled = true;
    
    Promise.all([
        fetch('{% url "management:sync_votes_ajax" %}', { method: 'POST' }),
        fetch('{% url "management:sync_results_ajax" %}', { method: 'POST' })
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(results => {
        let success = true;
        let messages = [];
        
        results.forEach(result => {
            if (result.success) {
                messages.push(result.message);
            } else {
                success = false;
                messages.push(result.error || 'Sync failed');
            }
        });
        
        if (success) {
            showAlert('success', 'All data synced successfully');
        } else {
            showAlert('danger', 'Some sync operations failed: ' + messages.join(', '));
        }
    })
    .catch(error => {
        showAlert('danger', 'Sync failed: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function performSync(type, url) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Syncing ${type}...`;
    btn.disabled = true;
    
    fetch(url, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
            } else {
                showAlert('danger', data.error || `Failed to sync ${type}`);
            }
        })
        .catch(error => {
            showAlert('danger', `Failed to sync ${type}: ` + error.message);
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

// Export data
function exportData() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
    btn.disabled = true;
    
    fetch('{% url "management:dashboard_stats_ajax" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const exportData = {
                    exported_at: new Date().toISOString(),
                    stats: data.stats,
                    votes: [], // Would need separate endpoint for detailed votes
                    metadata: {
                        source: 'Django Admin Interface',
                        version: '1.0'
                    }
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `voting-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('success', 'Data exported successfully');
            } else {
                showAlert('danger', 'Failed to export data: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            showAlert('danger', 'Export failed: ' + error.message);
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

// Reset confirmation
function showResetConfirmation() {
    const modal = new bootstrap.Modal(document.getElementById('resetConfirmationModal'));
    modal.show();
}

function showResetDevicesConfirmation() {
    const modal = new bootstrap.Modal(document.getElementById('resetDevicesModal'));
    modal.show();
}

// Enable/disable reset button based on confirmation text
document.getElementById('resetConfirmationInput').addEventListener('input', function() {
    const confirmBtn = document.getElementById('confirmResetBtn');
    const input = this.value.trim();
    confirmBtn.disabled = input !== 'RESET ALL VOTES';
});

// Enable/disable reset devices button based on confirmation text
document.getElementById('resetDevicesInput').addEventListener('input', function() {
    const confirmBtn = document.getElementById('confirmResetDevicesBtn');
    const input = this.value.trim();
    confirmBtn.disabled = input !== 'RESET DEVICES';
});

// Reset all votes
function resetAllVotes() {
    const btn = document.getElementById('confirmResetBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Resetting...';
    btn.disabled = true;
    
    fetch('{% url "management:reset_votes_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ confirm: true })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'All voting data has been reset successfully');
            const modal = bootstrap.Modal.getInstance(document.getElementById('resetConfirmationModal'));
            modal.hide();
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', 'Failed to reset votes: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        showAlert('danger', 'Reset failed: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Reset all devices
function resetAllDevices() {
    const btn = document.getElementById('confirmResetDevicesBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Resetting...';
    btn.disabled = true;
    
    fetch('{% url "management:reset_devices_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ confirm: true })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            const modal = bootstrap.Modal.getInstance(document.getElementById('resetDevicesModal'));
            modal.hide();
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', 'Failed to reset device IDs: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        showAlert('danger', 'Reset failed: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Clear local cache
function clearLocalCache() {
    // Enhanced confirmation dialog
    const result = confirm(
        'üóÉÔ∏è Clear Local Cache\n\n' +
        'This will clear only the Django database cache.\n' +
        'Backend server data will remain safe.\n\n' +
        '‚úÖ Safe operation - no data loss\n' +
        'üîÑ Fresh data will be loaded on next sync\n\n' +
        'Continue?'
    );
    
    if (result) {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Clearing Cache...';
        btn.disabled = true;
        
        // Simulate cache clearing (would need actual endpoint)
        setTimeout(() => {
            showAlert('success', 
                '‚úÖ Local cache cleared successfully! ' +
                'Fresh data will be loaded on next sync operation.'
            );
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1500);
    }
}

// Alert function
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    const firstRow = container.querySelector('.row');
    container.insertBefore(alertDiv, firstRow);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
